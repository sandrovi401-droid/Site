<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Antenna Compass</title>

<script src="https://cdn.tailwindcss.com"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.85)}
.dark .glass{background:rgba(17,24,39,.9)}
</style>
</head>

<body class="transition-colors duration-300">

<div id="map"></div>

<!-- CONTROL PANEL -->
<div class="absolute top-4 left-4 z-[1000] w-80 space-y-3">
  <div class="glass rounded-xl p-4 shadow-lg space-y-3">
    <h1 class="font-bold text-lg">üì° Antenna Compass</h1>

    <!-- MODE -->
    <div class="flex gap-2">
      <button id="modeA" class="flex-1 py-2 rounded bg-blue-500 text-white">–Ø (A)</button>
      <button id="modeB" class="flex-1 py-2 rounded bg-gray-200">–í—ã—à–∫–∞ (B)</button>
    </div>

    <p id="modeHint" class="text-sm text-gray-600">
      –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
    </p>

    <!-- SEARCH -->
    <input id="search" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="w-full p-2 rounded border"/>

    <!-- BUTTONS -->
    <div class="flex gap-2">
      <button id="locate" class="flex-1 py-2 bg-green-500 text-white rounded">
        –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
      </button>
      <button id="theme" class="px-3 py-2 bg-gray-300 rounded">üåô</button>
    </div>

    <!-- MAP TYPE -->
    <select id="mapStyle" class="w-full p-2 rounded border">
      <option value="light">–°–≤–µ—Ç–ª–∞—è –∫–∞—Ä—Ç–∞</option>
      <option value="dark">–¢—ë–º–Ω–∞—è –∫–∞—Ä—Ç–∞</option>
    </select>

    <button id="copy" class="w-full py-2 bg-gray-800 text-white rounded">
      –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
    </button>
  </div>
</div>

<!-- COMPASS -->
<div class="absolute bottom-6 right-6 z-[1000]">
  <div class="glass rounded-full w-28 h-28 flex items-center justify-center shadow-xl">
    <div class="relative w-20 h-20 rounded-full border-2 border-gray-400 flex items-center justify-center">
      <div id="arrow" class="absolute w-1 h-8 bg-red-500 origin-bottom"></div>
      <span class="absolute top-1 text-xs font-bold">N</span>
    </div>
  </div>
</div>

<!-- DISTANCE -->
<div class="absolute bottom-6 left-4 z-[1000] glass rounded-lg px-4 py-2 shadow">
  <span id="distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ‚Äî</span>
</div>

<script>
/* ---------- MAP ---------- */
const map = L.map('map',{zoomControl:false});
L.control.zoom({position:'bottomright'}).addTo(map);

const tiles = {
  light: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}),
  dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:19})
};
tiles.light.addTo(map);

let currentTiles = 'light';

/* ---------- STATE ---------- */
let mode = 'A';

let A = L.marker([39.8283,-98.5795],{draggable:true}).addTo(map);
let B = L.marker([39.83,-98.57],{draggable:true}).addTo(map);
let line = L.polyline([],{color:'#3b82f6',weight:3}).addTo(map);

/* ---------- GEO ---------- */
function distance(a,b){
  const R=6371e3;
  const œÜ1=a.lat*Math.PI/180, œÜ2=b.lat*Math.PI/180;
  const dœÜ=(b.lat-a.lat)*Math.PI/180;
  const dŒª=(b.lng-a.lng)*Math.PI/180;
  const x=Math.sin(dœÜ/2)**2+
          Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(a,b){
  const œÜ1=a.lat*Math.PI/180, œÜ2=b.lat*Math.PI/180;
  const dŒª=(b.lng-a.lng)*Math.PI/180;
  const y=Math.sin(dŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-
          Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(dŒª);
  return Math.atan2(y,x)*180/Math.PI;
}

function update(){
  const a=A.getLatLng(), b=B.getLatLng();
  line.setLatLngs([a,b]);

  const d=distance(a,b);
  document.getElementById('distance').innerText=
    d<1000?`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${Math.round(d)} –º`
          :`–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${(d/1000).toFixed(2)} –∫–º`;

  const rot=bearing(a,b);
  document.getElementById('arrow').style.transform=`rotate(${rot}deg)`;
  updateURL();
}

A.on('drag',update);
B.on('drag',update);

/* ---------- MODES ---------- */
modeA.onclick=()=>{
  mode='A';
  modeA.className="flex-1 py-2 rounded bg-blue-500 text-white";
  modeB.className="flex-1 py-2 rounded bg-gray-200";
  modeHint.innerText="–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ";
};
modeB.onclick=()=>{
  mode='B';
  modeB.className="flex-1 py-2 rounded bg-red-500 text-white";
  modeA.className="flex-1 py-2 rounded bg-gray-200";
  modeHint.innerText="–í—ã–±–µ—Ä–∏—Ç–µ –≤—ã—à–∫—É –∏–ª–∏ –∞–Ω—Ç–µ–Ω–Ω—É";
};

/* ---------- MAP CLICK ---------- */
map.on('click',e=>{
  if(mode==='A') A.setLatLng(e.latlng);
  else B.setLatLng(e.latlng);
  update();
});

/* ---------- SEARCH ---------- */
search.onkeydown=async e=>{
  if(e.key!=='Enter')return;
  if(mode==='A'){
    const r=await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${search.value}`
    ).then(r=>r.json());
    if(r[0]){
      A.setLatLng([r[0].lat,r[0].lon]);
      map.setView([r[0].lat,r[0].lon],15);
      update();
    }
  }else{
    const q=`[out:json];
      node(around:20000,${A.getLatLng().lat},${A.getLatLng().lng})
      [man_made~"tower|mast|antenna"];
      out;`;
    const r=await fetch(
      'https://overpass-api.de/api/interpreter',
      {method:'POST',body:q}
    ).then(r=>r.json());
    if(r.elements[0]){
      B.setLatLng([r.elements[0].lat,r.elements[0].lon]);
      map.setView([r.elements[0].lat,r.elements[0].lon],15);
      update();
    }else alert('–í—ã—à–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
  }
};

/* ---------- GEOLOCATION ---------- */
locate.onclick=()=>{
  map.locate({setView:true});
  map.once('locationfound',e=>{
    A.setLatLng(e.latlng);
    update();
  });
};

/* ---------- THEME ---------- */
theme.onclick=()=>{
  document.body.classList.toggle('dark');
};

mapStyle.onchange=e=>{
  map.removeLayer(tiles[currentTiles]);
  currentTiles=e.target.value;
  tiles[currentTiles].addTo(map);
};

/* ---------- PERMALINK ---------- */
function updateURL(){
  const a=A.getLatLng(), b=B.getLatLng();
  const p=new URLSearchParams({
    aLat:a.lat,aLng:a.lng,
    bLat:b.lat,bLng:b.lng,
    z:map.getZoom(),
    map:currentTiles
  });
  history.replaceState({},'',`?${p}`);
}

(function load(){
  const p=new URLSearchParams(location.search);
  if(p.get('aLat')){
    A.setLatLng([+p.get('aLat'),+p.get('aLng')]);
    B.setLatLng([+p.get('bLat'),+p.get('bLng')]);
    map.setView(A.getLatLng(),+p.get('z'));
    if(p.get('map')) mapStyle.value=p.get('map'),mapStyle.onchange({target:mapStyle});
  }else{
    map.setView(A.getLatLng(),5);
  }
  update();
})();

copy.onclick=()=>navigator.clipboard.writeText(location.href);
</script>
</body>
</html>